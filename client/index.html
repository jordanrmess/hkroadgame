<!-- This file displays whatever we want to display to the client -->
<!DOCTYPE html>
<html>
<head>
    <title>Multiplayer Game</title>

    <canvas id="ctx" width="725" height="408" style="border:1px solid #000000;"></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>

    <!-- ***** SCRIPT STARTS HERE ***** -->
    <script>
        // container for the images
        var Img = {};

        // Player (bunny) images
        Img.player1 = new Image();
        Img.player1.src = "/client/img/player1.png";
        Img.player2 = new Image();
        Img.player2.src = "/client/img/player2.png";        
        // Map image
        Img.map = new Image();
        Img.map.src = "/client/img/map.svg";

        // Car image
        Img.car = new Image();
        Img.car.src = "/client/img/car1.png";


        var ctx = document.getElementById("ctx").getContext("2d");
        ctx.font="30px Arial";

        // Initializes a connection between the client and the server.
        var socket=io();

        var Player = function(initPack){
            var self = {};
            self.id = initPack.id;
            self.number = initPack.number;
            self.x = initPack.x;
            self.y = initPack.y;
            self.score = initPack.score;            

            self.draw = function(){
                if(self.number === "1"){
                    var width = Img.player1.width;
                    var height = Img.player1.height;

                    ctx.drawImage(Img.player1, 0, 0, Img.player1.width, Img.player1.height, self.x-width/2, self.y-height/2, width, height);

                } else if(self.number === "2"){
                    var width = Img.player2.width;
                    var height = Img.player2.height;

                    ctx.drawImage(Img.player2, 0, 0, Img.player2.width, Img.player2.height, self.x-width/2, self.y-height/2, width, height);

                }
            }


            Player.list[self.id] = self;
            console.log(initPack);
            return self;

        }
        Player.list = {};

        var selfId = null;

        var Car = function(initPack){
            console.log("CAR's INITPACK", initPack);
            var self = {}; 
            self.id = initPack.id; 
            self.x  = initPack.x; 
            self.y = initPack.y; 
            
            
            self.draw = function() {
                var width = Img.car.width*0.20;
                var height = Img.car.height*0.20;
                console.log(self.x, self.y);
                ctx.drawImage(Img.car, 0, 0, Img.car.width, Img.car.height, self.x-width/2, self.y-height/2, width, height);

            }
            Car.list[self.id] = self; 
            return self;
        }
        Car.list = {}; 

    
        // init, when new entities are created, contains all data
        socket.on("init", function(data){
            if(data.selfId){
                //console.log("DEN FANNS: "+ data.selfId);
                selfId = data.selfId;
                //console.log("OCH DEN Ã„R NU: "+selfId);
            }
            for(var i = 0; i < data.player.length;i++){
                new Player(data.player[i]);
            }
            for(var i = 0; i < data.car.length;i++){
                new Car(data.car[i]);
            }

           
        });

        // update, only contains the difference
        socket.on("update", function(data){
            for (var i = 0; i < data.player.length; i++){
                var pack = data.player[i];
                var p = Player.list[pack.id];
                //console.log(pack);
                if(p){
                    if(pack.x !== undefined)
                        p.x = pack.x;
                    if(pack.y !== undefined)
                        p.y = pack.y;
                    if(pack.score !== undefined)
                        p.score = pack.score;
                }
            }
            console.log("data.car",data.car);
            for (var i = 0; i < data.car.length; i++){
                var pack = data.car[i];
                var c = Car.list[pack.id];
                
                if(c){
                    if(pack.x !== undefined)
                        c.x = pack.x;
                    if(pack.y !== undefined)
                        c.y = pack.y;
                }
            }

        });

        // remove, notifies the client if entity has been removed
        socket.on("remove",function(data){
            for(var i=0; i<data.player.length; i++){
                delete Player.list[data.player[i]];
            }
        });

        // loop for drawing players in local Player list
        setInterval(function(){
            if(!selfId){
                return;
            }
            ctx.clearRect(0,0,725,408);
            drawMap();
            drawScore();
            for(var i in Player.list){
                Player.list[i].draw();
            }
            for(var i in Car.list){
                Car.list[i].draw();
            }

        }, 40);

        var drawMap = function(){
            ctx.drawImage(Img.map,0,0);
        }

        var drawScore = function(){
            ctx.fillStyle = "white";
            //console.log("SCORE is: " +Player.list[selfId].score);
            var score = Player.list[selfId].score;
            ctx.fillText(score, 0, 30);
        }

        // On key press
        document.addEventListener("keydown",function(event){
            console.log(event.keyCode);
            if(event.keyCode === 39){
                console.log("hit right key");
                socket.emit('keyPress',{inputId:'right',state:true});
            }
            else if(event.keyCode === 40)
                socket.emit('keyPress',{inputId:'down',state:true});
            else if(event.keyCode === 37)
                socket.emit('keyPress',{inputId:'left',state:true});
            else if(event.keyCode === 38)
                socket.emit('keyPress',{inputId:'up',state:true});
        });

        // On key release, stop all movement
        document.addEventListener("keyup", function(event){
            if(event.keyCode === 39)
                socket.emit('keyPress',{inputId:'right',state:false});
            else if(event.keyCode === 40)
                socket.emit('keyPress',{inputId:'down',state:false});
            else if(event.keyCode === 37)
                socket.emit('keyPress',{inputId:'left',state:false});
            else if(event.keyCode === 38)
                socket.emit('keyPress',{inputId:'up',state:false});
        });
    </script>

</head>
<body>
</body>
</html>







