<!-- This file displays whatever we want to display to the client -->
<!DOCTYPE html>
<html>
<head>
    <title>Multiplayer Game</title>

    <canvas id="ctx" width="500" height="500" style="border:1px solid #000000;"></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>

    <!-- ***** SCRIPT STARTS HERE ***** -->
    <script>
        // container for the images
        var Img = {};

        Img.player = new Image();
        Img.player.src = "/client/img/bunny.png";

        var ctx = document.getElementById("ctx").getContext("2d");
        ctx.font="30px Arial";

        // Initializes a connection between the client and the server.
        var socket=io();

        var Player = function(initPack){
            var self = {};
            self.id = initPack.id;
            self.number = initPack.number;
            self.x = initPack.x;
            self.y = initPack.y;
            Player.list[self.id] = self;
            return self;
        }
        Player.list = {};

        // init, when new entities are created, contains all data
        socket.on("init", function(data){
            for(var i = 0; i < data.player.length;i++){
                new Player(data.player[i]);
            }
        });

        // update, only contains the difference
        socket.on("update", function(data){
            for (var i = 0; i < data.player.length; i++){
                var pack = data.player[i];
                var p = Player.list[pack.id];
                if(p){
                    if(pack.x !== undefined)
                        p.x = pack.x;
                    if(pack.y !== undefined)
                        p.y = pack.y;
                }
            }
        });

        // remove, notifies the client if entity has been removed
        socket.on("remove",function(data){
            for(var i=0; i<data.player.length; i++){
                delete Player.list[data.player[i]];
            }
        });

        // loop for drawing players in local Player list
        setInterval(function(){
            ctx.clearRect(0,0,500,500);
            for(var i in Player.list){
                ctx.fillText(Player.list[i].number, Player.list[i].x, Player.list[i].y);
            }
        }, 40);

        // socket.on('newPositions',function(data){
        //     ctx.clearRect(0,0,500,500);
        //     for(var i=0; i< data.player.length;i++){
        //        ctx.fillText(data.player[i].number,data.player[i].x, data.player[i].y); 
        //     }
        // });

        // On key press
        document.addEventListener("keydown",function(event){
            console.log(event.keyCode);
            if(event.keyCode === 39){
                console.log("hit right key");
                socket.emit('keyPress',{inputId:'right',state:true});
            }
            else if(event.keyCode === 40)
                socket.emit('keyPress',{inputId:'down',state:true});
            else if(event.keyCode === 37)
                socket.emit('keyPress',{inputId:'left',state:true});
            else if(event.keyCode === 38)
                socket.emit('keyPress',{inputId:'up',state:true});
        });

        // On key release, stop all movement
        document.addEventListener("keyup", function(event){
            if(event.keyCode === 39)
                socket.emit('keyPress',{inputId:'right',state:false});
            else if(event.keyCode === 40)
                socket.emit('keyPress',{inputId:'down',state:false});
            else if(event.keyCode === 37)
                socket.emit('keyPress',{inputId:'left',state:false});
            else if(event.keyCode === 38)
                socket.emit('keyPress',{inputId:'up',state:false});
        });
    </script>

</head>
<body>
<button onclick="happy()">Happy</button>
</body>
</html>







